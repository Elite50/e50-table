/*! e50-table 2014-12-09 */
"use strict";angular.module("e50Table",["ngResource"]),angular.module("e50Table").directive("e50Fetch",["$parse","$resource","Poll",function(a,b,c){return{restrict:"A",require:"e50Table",link:function(d,e,f){function g(b,c){j=!0,n=a(f.e50FetchParams)(d),o=a(f.e50FetchBody)(d);var e=!1;if(m){var g=n&&p in n?n:o,i=n&&q in n?n:o;c&&!l?(g.offset=r,e=!0):l&&(b||c)?i.limit=s:(r=g.offset,s=i.limit)}return"e50Loading"in f&&!b&&!c&&("emit"!==f.e50Loading&&d.$broadcast("loading-show","e50-table-loading"),"broadcast"!==f.e50Loading&&d.$emit("loading-show","e50-table-loading")),"e50InfiniteLoading"in f&&c&&("emit"!==f.e50InfiniteLoading&&d.$broadcast("loading-show","e50-table-infinite-loading"),"broadcast"!==f.e50InfiniteLoading&&d.$emit("loading-show","e50-table-infinite-loading")),u.fetch(n,o).$promise.then(function(a){if(angular.equals(d.e50GetData(),a.data))c&&(k=!1);else{if(k=!0,e){var b=a.data,g=d.e50GetData();"e50DataProp"in f&&(b=b[f.e50DataProp],g=g[f.e50DataProp]),b.length||(k=!1),Array.prototype.push.apply(g,b)}else d.e50SetData(a.data);m&&h()}}).finally(function(){j=!1,"e50Loading"in f&&!b&&!c&&("emit"!==f.e50Loading&&d.$broadcast("loading-hide","e50-table-loading"),"broadcast"!==f.e50Loading&&d.$emit("loading-hide","e50-table-loading")),"e50InfiniteLoading"in f&&c&&("emit"!==f.e50InfiniteLoading&&d.$broadcast("loading-hide","e50-table-infinite-loading"),"broadcast"!==f.e50InfiniteLoading&&d.$emit("loading-hide","e50-table-infinite-loading"))})}function h(){var a=i(e);a.on("scroll",function(){var b=e[0].querySelectorAll("[e50-table-row]:last-child");angular.forEach(b,function(b){b.offsetHeight&&b.offsetTop<a[0].scrollTop+a[0].offsetHeight&&!j&&k&&(l?s+=t:r+=s,g(!1,!0))})})}function i(a){var b,c=a.css("position"),d="absolute"===c;for(b=a.parent();b&&(d&&"static"===b.css("position")||!/(auto|scroll)/.test(b.css("overflow")+b.css("overflow-y")+b.css("overflow-x")));b=b.parent());return"fixed"!==c&&b?b:angular.element(a[0].ownerDocument||document)}var j=!1,k=!0,l="e50Poll"in f,m="e50InfiniteScroll"in f,n=angular.copy(a(f.e50FetchParams)(d)),o=angular.copy(a(f.e50FetchBody)(d));if(m)var p="e50OffsetKey"in f?f.e50OffsetKey:"offset",q="e50LimitKey"in f?f.e50LimitKey:"limit",r=n&&p in n?n.offset:o.offset,s=n&&q in n?n.limit:o.limit,t=s;var u=b(f.e50Fetch,{},{fetch:{method:"e50FetchMethod"in f?f.e50FetchMethod:"GET"}});if("e50FetchOnce"in f?g():d.$watch(function(){return[a(f.e50FetchParams)(d),a(f.e50FetchBody)(d)]},function(){"e50FetchLimit"in f&&"e50FetchLimitProp"in f&&d.e50GetData()[f.e50FetchLimitProp]<=f.e50FetchLimit||g()},!0),l){var v=new c(function(){return g(!0)},f.e50Poll);d.$on("$destroy",function(){v.stop()})}}}}]),angular.module("e50Table").directive("e50Hover",function(){return{restrict:"A",link:function(a,b,c){var d=c.e50Hover?c.e50Hover:"hover";b.on("mouseenter",function(){b.addClass(d)}).on("mouseleave",function(){b.removeClass(d)})}}}),angular.module("e50Table").directive("e50IfData",function(){return{restrict:"A",require:"^e50Table",link:function(a,b,c,d){var e="false"!==c.e50IfData,f=c.e50IfNoData?c.e50IfNoData:null,g=angular.element('<div class="e50-no-data">'+f+"</div>");a.$watchCollection("e50GetData()",function(a){var c="e50DataProp"in d.$attrs?a[d.$attrs.e50DataProp]:a;"undefined"!=typeof c&&(c.length&&e||!c.length&&!e)?(f&&g.remove(),b.removeClass("ng-hide")):(f&&b.parent()[0].insertBefore(g[0],b[0]),b.addClass("ng-hide"))})}}}),angular.module("e50Table").directive("e50NoProp",function(){return{restrict:"A",link:function(a,b){b.on("click",function(a){a.stopPropagation()})}}}),angular.module("e50Table").directive("e50Table",["$parse",function(a){return{restrict:"A",scope:!0,controller:["$scope","$attrs",function(a,b){this.$scope=a,this.$attrs=b}],compile:function(b,c){var d=b[0].querySelectorAll("[e50-table-row]");return angular.forEach(d,function(a){var b=document.createAttribute("ng-repeat"),d="e50DataKey"in c?c.e50DataKey:"t",e="e50DataProp"in c?"."+c.e50DataProp:"";b.value=d+" in e50GetData()"+e+" | orderBy : e50Sort : e50SortReverse | filter : e50Filter",a.attributes.setNamedItem(b)}),function(b,c,d){if(b.e50Filter=function(c){return"e50Filter"in d?a(d.e50Filter)(b)(c):!0},b.e50DeleteRow=function(a){angular.forEach(b.e50GetData(),function(c,d){c===a&&b.e50GetData().splice(d,1)})},d.$observe("e50Sort",function(a){b.e50Sort=a}),d.$observe("e50SortReverse",function(a){b.e50SortReverse=a}),"e50Data"in d)b.e50GetData=function(){return a(d.e50Data)(b)},b.e50SetData=function(c){a(d.e50Data).assign(b.$parent,c)};else{var e=[];b.e50GetData=function(){return e},b.e50SetData=function(a){e=a}}}}}}]),angular.module("e50Table").directive("e50View",function(){return{restrict:"A",require:"^e50Table",link:function(a,b,c,d){d.$attrs.$observe("e50Views",function(a){a===c.e50View?b.removeClass("ng-hide"):b.addClass("ng-hide")})}}}),angular.module("e50Table").factory("Poll",["$timeout",function(a){function b(a,b){this.delay=b?b:1e3,this.callback=a,this.poll()}return b.prototype.poll=function(){var b=this;this.callback().finally(function(){b.timeout=a(function(){b.poll()},b.delay)})},b.prototype.stop=function(){a.cancel(this.timeout)},b}]);