/*! e50-table 2015-04-10 */
"use strict";angular.module("e50Table",["ngResource"]),angular.module("e50Table").directive("e50Fetch",["$parse","$resource","Poll","$timeout",function(a,b,c,d){return{restrict:"A",require:"e50Table",link:function(e,f,g){function h(b,c){j=!0,q=angular.copy(a(g.e50FetchParams)(e)),r=angular.copy(a(g.e50FetchBody)(e));var f=!1;if(m){var h=q&&s in q?q:r,i=q&&t in q?q:r;c&&!l?(h[s]=u,f=!0):l&&(b||c)?i[t]=v:(u=h[s],v=i[t])}"e50Loading"in g&&!b&&!c&&o&&("emit"!==g.e50Loading&&e.$broadcast("loading-show","e50-table-loading"),"broadcast"!==g.e50Loading&&e.$emit("loading-show","e50-table-loading")),"e50InfiniteLoading"in g&&c&&("emit"!==g.e50InfiniteLoading&&e.$broadcast("loading-show","e50-table-infinite-loading"),"broadcast"!==g.e50InfiniteLoading&&e.$emit("loading-show","e50-table-infinite-loading"));var n=p;return b||(p++,n=p),x.fetch(q,r).$promise.then(function(a){if(n===p)if(angular.equals(e.e50GetData(),a.data))c&&(k=!1);else{if(k=!0,f){var b=a.data,h=e.e50GetData();"e50DataProp"in g&&(b=b[g.e50DataProp],h=h[g.e50DataProp]),b.length||(k=!1),Array.prototype.push.apply(h,b)}else e.e50SetData(a.data);d(e.e50InfiniteScroll)}}).finally(function(){j=!1,"e50Loading"in g&&!b&&!c&&o&&("emit"!==g.e50Loading&&e.$broadcast("loading-hide","e50-table-loading"),"broadcast"!==g.e50Loading&&e.$emit("loading-hide","e50-table-loading")),"e50InfiniteLoading"in g&&c&&("emit"!==g.e50InfiniteLoading&&e.$broadcast("loading-hide","e50-table-infinite-loading"),"broadcast"!==g.e50InfiniteLoading&&e.$emit("loading-hide","e50-table-infinite-loading")),o=!0})}function i(a){var b,c=a.css("position"),d="absolute"===c;for(b=a.parent();b[0]&&(d&&"static"===b.css("position")||!/(auto|scroll)/.test(b.css("overflow")+b.css("overflow-y")+b.css("overflow-x")));b=b.parent());return"fixed"!==c&&b?b:angular.element(a[0].ownerDocument||document)}var j=!1,k=!0,l="e50Poll"in g,m="e50InfiniteScroll"in g,n=!1,o=!1,p=0,q=angular.copy(a(g.e50FetchParams)(e)),r=angular.copy(a(g.e50FetchBody)(e));if(m)var s="e50OffsetKey"in g?g.e50OffsetKey:"offset",t="e50LimitKey"in g?g.e50LimitKey:"limit",u=q&&s in q?q[s]:r[s],v=q&&t in q?q[t]:r[t],w=v;var x=b(g.e50Fetch,{},{fetch:{method:"e50FetchMethod"in g?g.e50FetchMethod:"GET"}});if("e50FetchOnce"in g?h():e.$watch(function(){return[a(g.e50FetchParams)(e),a(g.e50FetchBody)(e)]},function(){o&&"e50FetchLimit"in g&&"e50FetchLimitProp"in g&&e.e50GetData()[g.e50FetchLimitProp]<=g.e50FetchLimit||h()},!0),l){var y=new c(function(){return h(!0)},g.e50Poll);e.$on("$destroy",function(){y.stop()})}e.e50InfiniteScroll=function(a){m&&((!n||a)&&(n=i(f)),n.off("scroll"),n.on("scroll",function(){var a=f[0].querySelectorAll("[e50-table-row]:last-child");angular.forEach(a,function(a){a.offsetHeight&&a.offsetTop<n[0].scrollTop+n[0].offsetHeight+2*a.offsetHeight&&!j&&k&&(l?v+=w:u+=v,h(!1,!0))})}))},e.e50InfiniteScroll()}}}]),angular.module("e50Table").directive("e50Hover",["$parse",function(a){return{restrict:"A",link:function(b,c,d){var e=d.e50Hover?d.e50Hover:"hover";c.on("mouseenter",function(){"e50HoverIf"in d&&!a(d.e50HoverIf)(b)||c.addClass(e)}).on("mouseleave",function(){c.removeClass(e)})}}}]),angular.module("e50Table").directive("e50IfData",function(){return{restrict:"A",require:"^e50Table",link:function(a,b,c){var d="false"!==c.e50IfData,e=c.e50IfNoData?c.e50IfNoData:null,f=angular.element('<div class="e50-no-data">'+e+"</div>"),g="e50IfLoadingData"in c?c.e50IfLoadingData.length?c.e50IfLoadingData:"Loading data":null,h=angular.element('<div class="e50-no-data">'+g+"</div>");a.$watchCollection("e50FilteredData",function(a){"undefined"==typeof a?(g&&b.parent()[0].insertBefore(h[0],b[0]),f.remove(),d?b.addClass("ng-hide"):b.removeClass("ng-hide")):a.length?(f.remove(),h.remove(),d?b.removeClass("ng-hide"):b.addClass("ng-hide")):(e&&b.parent()[0].insertBefore(f[0],b[0]),h.remove(),d?b.addClass("ng-hide"):b.removeClass("ng-hide"))})}}}),angular.module("e50Table").directive("e50NoProp",function(){return{restrict:"A",link:function(a,b){b.on("click",function(a){a.stopPropagation()})}}}),angular.module("e50Table").directive("e50Table",["$parse",function(a){return{restrict:"A",scope:!0,controller:["$scope","$attrs",function(a,b){this.$scope=a,this.$attrs=b}],compile:function(b,c){var d=b[0].querySelectorAll("[e50-table-row]");return angular.forEach(d,function(a){var b=document.createAttribute("ng-repeat"),d="e50DataKey"in c?c.e50DataKey:"t",e="e50DataProp"in c?"."+c.e50DataProp:"";b.value=d+" in e50FilteredData = (e50GetData()"+e+" | orderBy : e50Sort : e50SortReverse | filter : e50Filter)",a.attributes.setNamedItem(b)}),function(b,c,d){var e=[],f=!1;if(b.e50Filter=function(c){return c&&"id"in c&&e.indexOf(c.id)>=0?!1:"e50Filter"in d?a(d.e50Filter)(b)(c):!0},b.e50DeleteRow=function(a){e.push(a.id)},b.$watch(function(){return[a(d.e50Sort)(b),a(d.e50SortReverse)(b)]},function(a){f||(b.e50Sort=a[0],b.e50SortReverse=a[1])},!0),b.$watch(function(){return a(d.e50SortLock)(b)},function(c){if(c){f=!0;for(var e=0;e<b.e50FilteredData.length;e++)b.e50FilteredData[e].e50SortLockIndex=e;b.e50Sort="e50SortLockIndex",b.e50SortReverse=!1}else f=!1,b.e50Sort=a(d.e50Sort)(b),b.e50SortReverse=a(d.e50SortReverse)(b)}),"e50Data"in d)b.e50GetData=function(){return a(d.e50Data)(b)},b.e50SetData=function(c){a(d.e50Data).assign(b.$parent,c)},b.$on("$destroy",function(){});else{var g=[];b.e50GetData=function(){return g},b.e50SetData=function(a){g=a},b.$on("$destroy",function(){})}}}}}]),angular.module("e50Table").directive("e50View",["$timeout",function(a){return{restrict:"A",require:"^e50Table",link:function(b,c,d,e){e.$attrs.$observe("e50Views",function(e){e===d.e50View?(c.removeClass("ng-hide"),a(function(){b.e50InfiniteScroll(!0)})):c.addClass("ng-hide")})}}}]),angular.module("e50Table").factory("Poll",["$timeout",function(a){function b(a,b){this.delay=b?b:1e3,this.callback=a,this.canceled=!1,this.wait()}return b.prototype.poll=function(){var a=this;document.hasFocus()?this.callback().finally(function(){a.canceled||a.wait()}):this.wait()},b.prototype.wait=function(){var b=this;this.timeout=a(function(){b.poll()},this.delay)},b.prototype.stop=function(){this.canceled=!0,a.cancel(this.timeout)},b}]);