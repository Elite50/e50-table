/*! e50-table 2015-12-17 */
"use strict";angular.module("e50Table",["ngResource"]),angular.module("e50Table").directive("e50DragHandle",function(){return{restrict:"A",link:function(a,b){b.css({cursor:"move"}),b.on("dragstart",function(){return!1}),b.on("mousedown",function(b){a.e50StartDrag(b)})}}}),angular.module("e50Table").directive("e50Drag",function(){return{restrict:"A",require:"^e50Table",link:function(a,b,c,d){function e(){var a=d.$element[0].querySelectorAll("[e50-table-row]"),b=[];return angular.forEach(a,function(a){b.push({top:a.getBoundingClientRect().top,left:a.getBoundingClientRect().left})}),b}function f(){var b="e50DataKey"in d.$attrs?d.$attrs.e50DataKey:"t";a[b].$$e50FindRow=!0;for(var c=0;c<a.e50FilteredData.length;c++)if(a.e50FilteredData[c].$$e50FindRow)return delete a[b].$$e50FindRow,c}function g(a,b){if("e50DragGravity"in c){var d=parseInt(c.e50DragGravity)||0,e=Math.abs(b-a),f=e>d?Math.round(Math.sqrt(e-d))+d:e;return a+(b>a?1:-1)*f}return a}function h(b,c){var d,f=Number.MAX_VALUE;angular.forEach(n,function(a,e){var g=a.top-b,h=a.left-c,i=Math.sqrt(g*g+h*h);f>i&&(f=i,d=e)}),o!==d&&(a.e50MoveData(o,d),o=d,n=e())}var i,j,k,l,m,n,o;a.e50StartDrag=function(a){l=b[0].getBoundingClientRect().top,m=b[0].getBoundingClientRect().left,j=a.clientY-l,k=a.clientX-m,n=e(),o=f(),b.addClass("e50-dragging"),"e50DragClass"in c&&b.addClass(c.e50DragClass),i=angular.element("<div></div>").css({position:"absolute",width:b[0].clientWidth,height:b[0].clientHeight,top:l,left:m,zIndex:1e7,cursor:"move"}).addClass("e50-drag-overlay"),"e50DragOverlayClass"in c&&i.addClass(c.e50DragOverlayClass),angular.element("body").append(i).css({userSelect:"none"}).on("mousemove",function(a){var b="e50DragX"in c?g(l,a.clientY-j):a.clientY-j,d="e50DragY"in c?g(m,a.clientX-k):a.clientX-k;i.css({top:b,left:d}),h(b,d)}).on("mouseup",function(){i.remove(),b.removeClass("e50-dragging"),"e50DragClass"in c&&b.removeClass(c.e50DragClass),angular.element("body").css({userSelect:""}).off("mouseup mousemove")})}}}}),angular.module("e50Table").directive("e50Fetch",["$parse","$resource","E50Poll","$timeout",function(a,b,c,d){return{restrict:"A",require:"e50Table",link:function(e,f,g){function h(b,c){i=!0,o=angular.copy(a(g.e50FetchParams)(e)),p=angular.copy(a(g.e50FetchBody)(e));var f=!1;if(b||!e.e50FilteredData||e.e50FilteredData.length||e.e50SetData(void 0),l){var h=o&&q in o?o:p,u=o&&r in o?o:p;c&&!k?(h[q]=s,f=!0):k&&(b||c)?u[r]=t:(s=h[q],t=u[r])}"e50Loading"in g&&!b&&!c&&m&&("emit"!==g.e50Loading&&e.$broadcast("loading-show","e50-table-loading"),"broadcast"!==g.e50Loading&&e.$emit("loading-show","e50-table-loading")),"e50InfiniteLoading"in g&&c&&("emit"!==g.e50InfiniteLoading&&e.$broadcast("loading-show","e50-table-infinite-loading"),"broadcast"!==g.e50InfiniteLoading&&e.$emit("loading-show","e50-table-infinite-loading"));var w=n;return b||(n++,w=n),v.fetch(o,p).$promise.then(function(b){if(w===n){if(angular.equals(e.e50GetData(),b.data))c&&(j=!1);else{if(j=!0,f){var h=b.data,i=e.e50GetData();"e50DataProp"in g&&(h=h[g.e50DataProp],i=i[g.e50DataProp]),h.length||(j=!1),Array.prototype.push.apply(i,h)}else e.e50SetData(b.data);l&&d(e.e50InfiniteScroll)}"e50IfSuccess"in g&&a(g.e50IfSuccess)(e)(b)}},function(b){"e50IfError"in g&&a(g.e50IfError)(e)(b)}).finally(function(){i=!1,"e50Loading"in g&&!b&&!c&&m&&("emit"!==g.e50Loading&&e.$broadcast("loading-hide","e50-table-loading"),"broadcast"!==g.e50Loading&&e.$emit("loading-hide","e50-table-loading")),"e50InfiniteLoading"in g&&c&&("emit"!==g.e50InfiniteLoading&&e.$broadcast("loading-hide","e50-table-infinite-loading"),"broadcast"!==g.e50InfiniteLoading&&e.$emit("loading-hide","e50-table-infinite-loading")),m=!0})}var i=!1,j=!0,k="e50Poll"in g,l="e50InfiniteScroll"in g,m=!1,n=0,o=angular.copy(a(g.e50FetchParams)(e)),p=angular.copy(a(g.e50FetchBody)(e));if(l)var q="e50OffsetKey"in g?g.e50OffsetKey:"offset",r="e50LimitKey"in g?g.e50LimitKey:"limit",s=o&&q in o?o[q]:p[q],t=o&&r in o?o[r]:p[r],u=t;var v=b(g.e50Fetch,{},{fetch:{method:"e50FetchMethod"in g?g.e50FetchMethod:"GET"}});if("e50FetchOnce"in g?h():e.$watch(function(){return[a(g.e50FetchParams)(e),a(g.e50FetchBody)(e)]},function(){m&&"e50FetchLimit"in g&&"e50FetchLimitProp"in g&&e.e50GetData()[g.e50FetchLimitProp]<=g.e50FetchLimit||h()},!0),k){var w=new c(function(){return h(!0)},g.e50Poll);e.$on("$destroy",function(){w.stop()})}e.$on("e50-infinite-scroll",function(){!i&&j&&(k?t+=u:s+=t,h(!1,!0))})}}}]),angular.module("e50Table").directive("e50Hover",["$parse",function(a){return{restrict:"A",link:function(b,c,d){var e=d.e50Hover?d.e50Hover:"hover";c.on("mouseenter",function(){"e50HoverIf"in d&&!a(d.e50HoverIf)(b)||c.addClass(e)}).on("mouseleave",function(){c.removeClass(e)})}}}]),angular.module("e50Table").directive("e50IfData",function(){return{restrict:"A",require:"^e50Table",link:function(a,b,c){var d="false"!==c.e50IfData,e=c.e50IfNoData?c.e50IfNoData:null,f=angular.element('<div class="e50-no-data">'+e+"</div>"),g="e50IfLoadingData"in c?c.e50IfLoadingData.length?c.e50IfLoadingData:"Loading data":null,h=angular.element('<div class="e50-no-data">'+g+"</div>");a.$watchCollection("e50FilteredData",function(a){"undefined"==typeof a?(g&&b.parent()[0].insertBefore(h[0],b[0]),f.remove(),d?b.css("display","none"):b.css("display","")):a.length?(f.remove(),h.remove(),d?b.css("display",""):b.css("display","none")):(e&&b.parent()[0].insertBefore(f[0],b[0]),h.remove(),d?b.css("display","none"):b.css("display",""))})}}}),angular.module("e50Table").directive("e50InfiniteScroll",["$parse",function(a){return{restrict:"A",require:"e50Table",link:function(b,c,d){function e(a){var b,c=a.css("position"),d="absolute"===c;for(b=a.parent();b[0]&&(d&&"static"===b.css("position")||!/(auto|scroll)/.test(b.css("overflow")+b.css("overflow-y")+b.css("overflow-x")));b=b.parent());return"fixed"!==c&&b?b:angular.element(a[0].ownerDocument||document)}var f=!1,g=0;b.e50InfiniteScroll=function(h){var i=g;(!f||h)&&(f=e(c)),f.off("scroll.e50Table"),f.on("scroll.e50Table",function(){var e=c[0].querySelectorAll("[e50-table-row]:last-child");angular.forEach(e,function(c){i===g&&c.offsetHeight&&c.offsetTop+c.offsetHeight<f[0].scrollTop+f[0].offsetHeight+200&&(g++,b.$broadcast("e50-infinite-scroll"),d.e50InfiniteScroll&&a(d.e50InfiniteScroll)(b)(function(a){b.e50InfiniteScroll(a)}))})})},b.e50InfiniteScroll()}}}]),angular.module("e50Table").directive("e50NoProp",function(){return{restrict:"A",link:function(a,b){b.on("click",function(a){a.stopPropagation()})}}}),angular.module("e50Table").directive("e50Table",["$parse",function(a){return{restrict:"A",scope:!0,controller:["$element","$attrs",function(a,b){this.$element=a,this.$attrs=b}],compile:function(b,c){var d=b[0].querySelectorAll("[e50-table-row]");return angular.forEach(d,function(a){var b=document.createAttribute("ng-repeat"),d="e50DataKey"in c?c.e50DataKey:"t",e="e50DataProp"in c?"."+c.e50DataProp:"";b.value=d+" in e50FilteredData = (e50GetData()"+e+" | orderBy : e50Sort : e50SortReverse | filter : e50Filter | limitTo : e50LimitTo)",a.attributes.setNamedItem(b)}),function(b,c,d){function e(a){var c=b.e50GetData();return"e50DataProp"in d&&(c=c[d.e50DataProp]),c.indexOf(a)}function f(c,e){e?j=c:a(d.e50Data).assign(b.$parent,c)}function g(a,b,c){if("undefined"==typeof a||"undefined"==typeof b)return f(b,c);var e=a,g=b;if("e50DataProp"in d){e=a[d.e50DataProp]?a[d.e50DataProp]:[],g=b[d.e50DataProp]?b[d.e50DataProp]:[];for(var h in a)h===d.e50DataProp||angular.equals(a[h],b[h])||(a[h]=b[h])}if(!e.length)return f(b,c);for(var i=0,j=!1;!j;i++)i===e.length?(j=!0,Array.prototype.push.apply(e,g.slice(i,g.length))):i===g.length?(j=!0,e.splice(i,e.length-i)):angular.equals(e[i],g[i])||(e[i]=g[i])}var h=[],i=!1;if(b.e50Filter=function(c){return c&&"id"in c&&h.indexOf(c.id)>=0?!1:"e50Filter"in d?a(d.e50Filter)(b)(c):!0},b.e50DeleteRow=function(a){h.push(a.id)},b.$watch(function(){return[a(d.e50Sort)(b),a(d.e50SortReverse)(b)]},function(a){i||(b.e50Sort=a[0]?a[0]:e,b.e50SortReverse=a[1]?!0:!1)},!0),b.$watch(function(){return a(d.e50SortLock)(b)},function(c){if(c){i=!0;for(var f=0;f<b.e50FilteredData.length;f++)b.e50FilteredData[f].$$e50SortLockIndex=f;b.e50Sort="$$e50SortLockIndex",b.e50SortReverse=!1}else{i=!1;var g=a(d.e50Sort)(b);b.e50Sort=g?g:e,b.e50SortReverse=a(d.e50SortReverse)(b)?!0:!1}}),b.$watch(function(){return[a(d.e50LimitTo)(b)]},function(a){b.e50LimitTo=a[0]?a[0]:4815162342},!0),"e50Data"in d)b.e50GetData=function(){return a(d.e50Data)(b)},b.e50SetData=function(c){g(a(d.e50Data)(b),c,!1)};else{var j=[];b.e50GetData=function(){return j},b.e50SetData=function(a){g(j,a,!0)}}b.e50MoveData=function(a,c){var e=b.e50GetData();"e50DataProp"in d&&(e=e[d.e50DataProp]?e[d.e50DataProp]:[]),b.e50FilteredData[a].$$e50MoveFrom=!0,b.e50FilteredData[c].$$e50MoveTo=!0;var f,g;angular.forEach(e,function(a,b){a.$$e50MoveFrom&&(f=b,delete a.$$e50MoveFrom),a.$$e50MoveTo&&(g=b,delete a.$$e50MoveTo)}),e.splice(g,0,e.splice(f,1)[0]),b.$digest()}}}}}]),angular.module("e50Table").directive("e50View",["$timeout",function(a){return{restrict:"A",require:"^e50Table",link:function(b,c,d,e){function f(e){e===d.e50View?(c.removeClass("ng-hide"),a(function(){b.e50InfiniteScroll&&b.e50InfiniteScroll(!0)})):c.addClass("ng-hide")}f(e.$attrs.e50Views),e.$attrs.$observe("e50Views",f)}}}]),angular.module("e50Table").factory("E50Poll",["$timeout",function(a){function b(a,b){console.log("hi"),this.delay=b?b:1e3,this.callback=a,this.canceled=!1,this.wait()}return b.prototype.poll=function(){var a=this;this.callback().finally(function(){a.canceled||a.wait()})},b.prototype.wait=function(){var b=this;this.timeout=a(function(){b.poll()},this.delay)},b.prototype.stop=function(){this.canceled=!0,a.cancel(this.timeout)},b}]);